"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ Claude AI —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
"""
from telebot import types
from loader import bot
from database.database import db
from utils import escape_html, safe_answer_callback
from config import TOKEN_PRICES
import json
from datetime import datetime, timedelta
import re


# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
generated_reviews_storage = {}


def get_review_date_range():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ (–æ—Ç 12 –¥–æ 8 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥)"""
    today = datetime.now()
    date_from = (today - timedelta(days=365)).strftime("%Y-%m-%d")  # 12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
    date_to = (today - timedelta(days=240)).strftime("%Y-%m-%d")    # 8 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
    return f"–º–µ–∂–¥—É {date_from} –∏ {date_to}"


@bot.callback_query_handler(func=lambda call: call.data.startswith("gen_reviews_"))
def handle_generate_reviews_start(call):
    """–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
    category_id = int(call.data.split("_")[-1])
    user_id = call.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    category = db.get_category(category_id)
    if not category:
        safe_answer_callback(bot, call.id, "‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    category_name = category.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
    
    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å
    tokens = db.get_user_tokens(user_id)
    
    text = (
        f"ü§ñ <b>–ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ó–´–í–û–í</b>\n"
        f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {escape_html(category_name)}\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: <b>{tokens:,}</b> —Ç–æ–∫–µ–Ω–æ–≤\n\n"
        "üí° <b>AI —Å–æ–∑–¥–∞—Å—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç–∑—ã–≤—ã:</b>\n"
        "‚Ä¢ –†–∞–∑–Ω—ã–µ –∏–º–µ–Ω–∞ –∏ –¥–∞—Ç—ã\n"
        "‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏\n"
        "‚Ä¢ –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã\n"
        "‚Ä¢ –†–∞–∑–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (3-5‚òÖ)\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
    )
    
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.row(
        types.InlineKeyboardButton("3 –æ—Ç–∑—ã–≤–∞ (30 —Ç–æ–∫–µ–Ω–æ–≤)", callback_data=f"gen_rev_exec_{category_id}_3"),
        types.InlineKeyboardButton("5 –æ—Ç–∑—ã–≤–æ–≤ (50 —Ç–æ–∫–µ–Ω–æ–≤)", callback_data=f"gen_rev_exec_{category_id}_5")
    )
    markup.row(
        types.InlineKeyboardButton("10 –æ—Ç–∑—ã–≤–æ–≤ (100 —Ç–æ–∫–µ–Ω–æ–≤)", callback_data=f"gen_rev_exec_{category_id}_10")
    )
    markup.add(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"category_reviews_{category_id}")
    )
    
    try:
        bot.edit_message_text(
            text,
            call.message.chat.id,
            call.message.message_id,
            reply_markup=markup,
            parse_mode='HTML'
        )
    except:
        bot.send_message(call.message.chat.id, text, reply_markup=markup, parse_mode='HTML')
    
    safe_answer_callback(bot, call.id)


@bot.callback_query_handler(func=lambda call: call.data.startswith("gen_rev_exec_"))
def handle_generate_reviews_execute(call):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ Claude AI"""
    parts = call.data.split("_")
    category_id = int(parts[3])
    count = int(parts[4])
    
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    category = db.get_category(category_id)
    if not category:
        safe_answer_callback(bot, call.id, "‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    category_name = category.get('name', '')
    description = category.get('description', '')
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
    cost = count * 10
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    tokens = db.get_user_tokens(user_id)
    if tokens < cost:
        bot.answer_callback_query(
            call.id,
            f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤! –ù—É–∂–Ω–æ: {cost}, —É –≤–∞—Å: {tokens}",
            show_alert=True
        )
        return
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã
    if not db.update_tokens(user_id, -cost):
        safe_answer_callback(bot, call.id, "‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤", show_alert=True)
        return
    
    new_balance = db.get_user_tokens(user_id)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    bot.edit_message_text(
        f"‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é {count} –æ—Ç–∑—ã–≤(–æ–≤) –¥–ª—è <b>{escape_html(category_name)}</b>...\n\n"
        f"–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥.",
        chat_id,
        call.message.message_id,
        parse_mode='HTML'
    )
    safe_answer_callback(bot, call.id)
    
    # –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
    date_range = get_review_date_range()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–π—Å –µ—Å–ª–∏ –µ—Å—Ç—å
    prices = category.get('prices', {})
    prices_text = ""
    if prices and isinstance(prices, dict):
        rows = prices.get('rows', [])
        if rows:
            prices_text = "\n\n–¶–ï–ù–´:\n"
            for item in rows[:5]:  # –ø–µ—Ä–≤—ã–µ 5 –ø–æ–∑–∏—Ü–∏–π
                name = item.get(list(item.keys())[0] if item.keys() else 'name', '')
                prices_text += f"- {name}\n"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –£–õ–£–ß–®–ï–ù–ù–´–ô –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
    prompt = f"""–¢—ã ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π –∫–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –æ—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ/—É—Å–ª—É–≥–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å {count} –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–• –æ—Ç–∑—ã–≤–æ–≤, –Ω–µ–æ—Ç–ª–∏—á–∏–º—ã—Ö –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä –û –ß–Å–ú –ü–ò–®–ï–ú:

–¢–æ–≤–∞—Ä/–£—Å–ª—É–≥–∞: {category_name}
"""
    
    if description:
        prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {description}\n"
    
    if prices_text:
        prompt += prices_text
    
    prompt += f"""

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è –ì–õ–ê–í–ù–û–ï: –ò–ó–ë–ï–ì–ê–ô –ò–°–ö–£–°–°–¢–í–ï–ù–ù–û–°–¢–ò!

üö´ –ù–ï –ü–ò–®–ò –ö–ê–ö –ú–ê–†–ö–ï–¢–û–õ–û–ì:
‚ùå "–∏–¥–µ–∞–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º", "–Ω–µ –ø–æ–∂–∞–ª–µ–ª–∞", "–æ—á–µ–Ω—å –¥–æ–≤–æ–ª—å–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º"
‚ùå "–æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä", "—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –≤—Å–µ–º", "–ø—Ä–µ–≤–∑–æ—à–ª–æ –æ–∂–∏–¥–∞–Ω–∏—è"
‚ùå –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ —Ö–≤–∞–ª–µ–±–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
‚ùå –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø—Ä–æ–¥—É–∫—Ç–∞
‚ùå –°–ª–∏—à–∫–æ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

‚úÖ –ü–ò–®–ò –ö–ê–ö –û–ë–´–ß–ù–´–ô –ß–ï–õ–û–í–ï–ö:
‚úÖ –ù–∞—á–Ω–∏ —Å —ç–º–æ—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã: "–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ!", "–î–æ–ª–≥–æ –¥—É–º–∞–ª–∏...", "–ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ –∏..."
‚úÖ –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä—ã–≤—ã –º—ã—Å–ª–∏: "...–≤ –æ–±—â–µ–º –¥–æ–≤–æ–ª—å–Ω—ã", "–∫–æ—Ä–æ—á–µ –≥–æ–≤–æ—Ä—è"
‚úÖ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Å–ª–æ–≤–µ—á–∫–∏: "—Ä–µ–∞–ª—å–Ω–æ", "–Ω–æ—Ä–º", "–≤–æ–æ–±—â–µ", "–∫—Å—Ç–∞", "–ø—Ä—è–º"
‚úÖ –ù–µ–∏–¥–µ–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞: –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–µ, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å
‚úÖ –õ–∏—á–Ω—ã–π –æ–ø—ã—Ç: "—É –Ω–∞—Å", "–º—ã –¥–µ–ª–∞–ª–∏", "—è –≤—ã–±–∏—Ä–∞–ª–∞"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üé≠ –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´:

1Ô∏è‚É£ –ù–ê–ß–ê–õ–û –û–¢–ó–´–í–ê (—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å!):
‚úÖ "–í–∑—è–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ–π..."
‚úÖ "–î–æ–ª–≥–æ –≤—ã–±–∏—Ä–∞–ª–∏, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞..."
‚úÖ "–†–µ–∞–ª—å–Ω–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!"
‚úÖ "–ù—É —á—Ç–æ —Å–∫–∞–∑–∞—Ç—å..."
‚úÖ "–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ä–µ—à–∏–ª–∏—Å—å"
‚úÖ "–î–µ–ª–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç –∏..."
‚ùå "–í—ã—Ä–∞–∂–∞—é –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏..."
‚ùå "–Ø–≤–ª—è—é—Å—å –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–∏..."

2Ô∏è‚É£ –°–¢–†–£–ö–¢–£–†–ê (–ù–ï –í–°–ï–ì–î–ê –õ–û–ì–ò–ß–ù–ê!):
‚úÖ –°–Ω–∞—á–∞–ª–∞ —ç–º–æ—Ü–∏—è, –ø–æ—Ç–æ–º –¥–µ—Ç–∞–ª–∏
‚úÖ –ü–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–Ω–∏–µ —Å —Ç–µ–º—ã –Ω–∞ —Ç–µ–º—É
‚úÖ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –≤–∞–∂–Ω–æ–≥–æ
‚úÖ –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –º—ã—Å–ª–∏
‚ùå –ß—ë—Ç–∫–æ–µ: "–ü–ª—é—Å—ã: 1, 2, 3. –ú–∏–Ω—É—Å—ã: 1, 2"
‚ùå –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ

3Ô∏è‚É£ –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨:
‚úÖ –í–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è! ("–í–æ–æ–±—â–µ –æ–≥–æ–Ω—å!")
‚úÖ –ú–Ω–æ–≥–æ—Ç–æ—á–∏—è... (–∑–∞–¥—É–º—á–∏–≤–æ—Å—Ç—å)
‚úÖ –°–∫–æ–±–æ—á–∫–∏ (—É—Ç–æ—á–Ω–µ–Ω–∏—è)
‚úÖ –°–º–∞–π–ª—ã –¥–æ–ø—É—Å—Ç–∏–º—ã: ) –∏–ª–∏ :)
‚úÖ –ö–ê–ü–° –¥–ª—è —ç–º–æ—Ü–∏–π (–Ω–æ —Ä–µ–¥–∫–æ!)
‚ùå –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
‚ùå –ë–∏–∑–Ω–µ—Å-—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏

4Ô∏è‚É£ –î–õ–ò–ù–ê –ò –°–¢–ò–õ–¨:

üîπ –ö–û–†–û–¢–ö–ò–ï (30% –æ—Ç–∑—ã–≤–æ–≤) - 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:
"–í–∑—è–ª–∏ –¥–ª—è –∫—É—Ö–Ω–∏. –°–º–æ—Ç—Ä–∏—Ç—Å—è –æ—Ç–ª–∏—á–Ω–æ, –º–æ–Ω—Ç–∞–∂ –±—ã—Å—Ç—Ä—ã–π. –î–æ–≤–æ–ª–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º)"

üîπ –°–†–ï–î–ù–ò–ï (50%) - 4-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
–ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–µ –∞–±–∑–∞—Ü—ã, –∂–∏–≤–∞—è —Ä–µ—á—å, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π –º–∏–Ω—É—Å –∏–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ.

üîπ –†–ê–ó–í–Å–†–ù–£–¢–´–ï (20%) - 8-15 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
–†–∞—Å—Å–∫–∞–∑ —Å –¥–µ—Ç–∞–ª—è–º–∏, –∏—Å—Ç–æ—Ä–∏—è –≤—ã–±–æ—Ä–∞, –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã, –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è. –ù–æ –ë–ï–ó –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –ø–∞—Ñ–æ—Å–∞!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

5Ô∏è‚É£ –ò–ú–ï–ù–ê (–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–ï!):

‚úÖ –ñ–µ–Ω—Å–∫–∏–µ: –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞, –ú–∞—Ä–∏–Ω–∞, –û–ª—å–≥–∞, –°–≤–µ—Ç–ª–∞–Ω–∞, –ê–Ω–Ω–∞, –ù–∞—Ç–∞–ª—å—è, –ò—Ä–∏–Ω–∞
‚úÖ –ú—É–∂—Å–∫–∏–µ: –î–º–∏—Ç—Ä–∏–π, –ê–Ω–¥—Ä–µ–π, –°–µ—Ä–≥–µ–π, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, –í–ª–∞–¥–∏–º–∏—Ä, –ò–≥–æ—Ä—å, –ú–∞–∫—Å–∏–º
‚úÖ –° –æ—Ç—á–µ—Å—Ç–≤–æ–º: –ò–≥–æ—Ä—å –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á, –û–ª—å–≥–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ (—Ä–µ–¥–∫–æ, –∑–≤—É—á–∏—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ)
‚úÖ –° –∏–Ω–∏—Ü–∏–∞–ª–æ–º: –ú–∞—Ä–∏–Ω–∞ –ö., –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ë., –î–º–∏—Ç—Ä–∏–π –°.
‚úÖ –£–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω—ã–µ: –ö–∞—Ç—è, –°–∞—à–∞ (–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ)
‚úÖ –¢–æ–ª—å–∫–æ —Ñ–∞–º–∏–ª–∏—è: –ü–µ—Ç—Ä–æ–≤, –°–æ–∫–æ–ª–æ–≤–∞ (—Ä–µ–¥–∫–æ)

‚ö†Ô∏è –ù–ï –ü–û–í–¢–û–†–Ø–ô –∏–º–µ–Ω–∞! –ö–∞–∂–¥—ã–π –æ—Ç–∑—ã–≤ = –Ω–æ–≤—ã–π —á–µ–ª–æ–≤–µ–∫!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

6Ô∏è‚É£ –î–ê–¢–´ (–†–ê–í–ù–û–ú–ï–†–ù–û–ï –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï!):

–ò—Å–ø–æ–ª—å–∑—É–π –¥–∞—Ç—ã {date_range}
‚ö†Ô∏è –ù–ï –∫—É—á–∫—É–π –≤—Å–µ –æ—Ç–∑—ã–≤—ã –≤ 1-2 –º–µ—Å—è—Ü–∞!
‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –†–ê–í–ù–û–ú–ï–†–ù–û –ø–æ –≤—Å–µ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É

–§–æ—Ä–º–∞—Ç: YYYY-MM-DD

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

7Ô∏è‚É£ –û–¶–ï–ù–ö–ò –ò –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–ï–ö–°–¢–£:

‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5‚òÖ) - 60% –æ—Ç–∑—ã–≤–æ–≤:
‚Ä¢ –¢–ï–ö–°–¢: –û—á–µ–Ω—å –¥–æ–≤–æ–ª–µ–Ω, –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ (–Ω–æ –ë–ï–ó –ø–∞—Ñ–æ—Å–∞!)
‚Ä¢ –ü–õ–Æ–°–´: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ ("–ë—ã—Å—Ç—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏", "–¶–µ–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è")
‚Ä¢ –ú–ò–ù–£–°–´: –ü–£–°–¢–û –∏–ª–∏ "–ù–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "-"

‚≠ê‚≠ê‚≠ê‚≠ê (4‚òÖ) - 30% –æ—Ç–∑—ã–≤–æ–≤:
‚Ä¢ –¢–ï–ö–°–¢: –•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π –º–∏–Ω—É—Å
‚Ä¢ –ü–õ–Æ–°–´: –ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å
‚Ä¢ –ú–ò–ù–£–°–´: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´! –ù–æ –Ω–µ–±–æ–ª—å—à–∏–µ:
  - "–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–¥–µ—Ä–∂–∞–ª–∞—Å—å –Ω–∞ 2 –¥–Ω—è"
  - "–ù–µ–º–Ω–æ–≥–æ –ø—ã–ª—å–Ω–æ –±—ã–ª–æ –ø—Ä–∏ –º–æ–Ω—Ç–∞–∂–µ"
  - "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±—ã–ª–∞ –∫–æ—Ä–æ—Ç–∫–∞—è"

‚≠ê‚≠ê‚≠ê (3‚òÖ) - 10% –æ—Ç–∑—ã–≤–æ–≤:
‚Ä¢ –¢–ï–ö–°–¢: –ù–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏
‚Ä¢ –ü–õ–Æ–°–´: –ß—Ç–æ-—Ç–æ –≤—Å—ë –∂–µ —Ö–æ—Ä–æ—à–æ
‚Ä¢ –ú–ò–ù–£–°–´: –°–ï–†–¨–Å–ó–ù–´–ï:
  - "–ö–∞—á–µ—Å—Ç–≤–æ –Ω–µ —Å—É–ø–µ—Ä, –∫–∞–∫ –æ–∂–∏–¥–∞–ª–∏"
  - "–ú–æ–Ω—Ç–∞–∂ –¥–æ–ª–≥–∏–π –ø–æ–ª—É—á–∏–ª—Å—è"
  - "–¶–µ–Ω–∞ –≤—ã—à–µ —á–µ–º —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

8Ô∏è‚É£ –ö–û–ù–ö–†–ï–¢–ò–ö–ê (–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –ï–°–¢–ï–°–¢–í–ï–ù–ù–û–°–¢–ò!):

‚úÖ –†–∞–∑–º–µ—Ä—ã: "—Å—Ç–µ–Ω–∞ 4 –Ω–∞ 3 –º–µ—Ç—Ä–∞", "–∫–æ–º–Ω–∞—Ç–∞ 20 –∫–≤–∞–¥—Ä–∞—Ç–æ–≤"
‚úÖ –í—Ä–µ–º—è: "–º–æ–Ω—Ç–∞–∂ –∑–∞ 4 —á–∞—Å–∞", "—Å–¥–µ–ª–∞–ª–∏ –∑–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ", "–Ω–µ–¥–µ–ª—è —É—à–ª–∞"
‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏—è: "—Å–º–æ—Ç—Ä–µ–ª–∏ –æ–±–æ–∏ - –¥–æ—Ä–æ–∂–µ –≤—ã—à–ª–æ", "—É —Å–æ—Å–µ–¥–µ–π –¥—Ä—É–≥–∏–µ –≤–∑—è–ª–∏"
‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: "3 —É–ø–∞–∫–æ–≤–∫–∏ —Ö–≤–∞—Ç–∏–ª–æ", "–∑–∞–∫–∞–∑—ã–≤–∞–ª–∏ 15 –∫–≤.–º."
‚úÖ –¶–µ–Ω—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ): "—É–ª–æ–∂–∏–ª–∏—Å—å –≤ 30 —Ç—ã—Å—è—á", "–≤—ã—à–ª–æ –¥–µ—à–µ–≤–ª–µ —á–µ–º –¥—É–º–∞–ª–∏"
‚úÖ –ú–µ—Å—Ç–æ: "–¥–ª—è —Å–ø–∞–ª—å–Ω–∏", "–Ω–∞ –∫—É—Ö–Ω—é", "–≤ –≥–æ—Å—Ç–∏–Ω—É—é"
‚úÖ –î–µ—Ç–∞–ª–∏: "—Ü–≤–µ—Ç —Å–µ—Ä—ã–π –≤—ã–±—Ä–∞–ª–∏", "–º–∞—Ç–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç", "–ø–æ–¥ –¥–µ—Ä–µ–≤–æ"

‚ùå –ò–∑–±–µ–≥–∞–π: "–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ", "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ", "–∏–¥–µ–∞–ª—å–Ω–æ" (—Å–ª–∏—à–∫–æ–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

9Ô∏è‚É£ –ü–†–ò–ú–ï–†–´ –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–• –§–†–ê–ó:

–ù–ê–ß–ê–õ–û:
‚Ä¢ "–í–∑—è–ª–∏ –¥–ª—è –∫—É—Ö–Ω–∏ –ø–æ—Å–ª–µ –¥–æ–ª–≥–∏—Ö —Ä–∞–∑–¥—É–º–∏–π..."
‚Ä¢ "–ù–∞–∫–æ–Ω–µ—Ü —Ä–µ—à–∏–ª–∏—Å—å –Ω–∞ —Ä–µ–º–æ–Ω—Ç –∏..."
‚Ä¢ "–î–µ–ª–∞–ª–∏ —Å–ø–∞–ª—å–Ω—é, –≤—ã–±–∏—Ä–∞–ª–∏ –¥–æ–ª–≥–æ..."
‚Ä¢ "–†–µ–∞–ª—å–Ω–æ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç!"
‚Ä¢ "–ù—É —á—Ç–æ —Å–∫–∞–∑–∞—Ç—å, –¥–æ–≤–æ–ª–µ–Ω)"

–°–ï–†–ï–î–ò–ù–ê:
‚Ä¢ "...–º–æ–Ω—Ç–∞–∂ –ø—Ä–∞–≤–¥–∞ –±—ã—Å—Ç—Ä—ã–π –±—ã–ª"
‚Ä¢ "...–≤ –æ–±—â–µ–º –Ω–æ—Ä–º –ø–æ–ª—É—á–∏–ª–æ—Å—å"
‚Ä¢ "...–∫—Å—Ç–∞ —Ü–µ–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è"
‚Ä¢ "...—Ö–æ—Ç—è —Å–Ω–∞—á–∞–ª–∞ —Å–æ–º–Ω–µ–≤–∞–ª–∏—Å—å"
‚Ä¢ "...–∫–æ—Ä–æ—á–µ –≥–æ–≤–æ—Ä—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é"

–ö–û–ù–ï–¶:
‚Ä¢ "–í —Ü–µ–ª–æ–º –¥–æ–≤–æ–ª—å–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º"
‚Ä¢ "–í—Ä–æ–¥–µ –≤—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø–æ–∫–∞"
‚Ä¢ "–ü–æ—Å–º–æ—Ç—Ä–∏–º –∫–∞–∫ –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç)"
‚Ä¢ "–ü–æ–∫–∞ —á—Ç–æ –≤—Å—ë –æ–∫"
‚Ä¢ "–î—É–º–∞—é —Ö–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä —Å–¥–µ–ª–∞–ª–∏"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîü –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô (–£–ë–ò–†–ê–ï–¢ –ï–°–¢–ï–°–¢–í–ï–ù–ù–û–°–¢–¨):

‚ùå SEO-—Å–ø–∞–º: "–≥–¥–µ –∫—É–ø–∏—Ç—å –≤ –ú–æ—Å–∫–≤–µ", "—Ü–µ–Ω–∞", "–∑–∞–∫–∞–∑–∞—Ç—å –¥–µ—à–µ–≤–æ"
‚ùå –®–∞–±–ª–æ–Ω—ã: "–û–≥—Ä–æ–º–Ω–æ–µ —Å–ø–∞—Å–∏–±–æ –∫–æ–º–ø–∞–Ω–∏–∏", "–í—ã—Ä–∞–∂–∞—é –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å"
‚ùå –ü–∞—Ñ–æ—Å: "–∏–¥–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ", "–ª—É—á—à–∏–π –≤—ã–±–æ—Ä –≤ –∂–∏–∑–Ω–∏"
‚ùå –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø–æ–¥—Ä—è–¥
‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ "–ü–ª—é—Å—ã: 1, 2, 3. –ú–∏–Ω—É—Å—ã: 1, 2, 3" (—Å–ª–∏—à–∫–æ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ)
‚ùå –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞ –∏ –¥–∞—Ç—ã
‚ùå –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìù –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (–°–¢–†–û–ì–û JSON):

```json
[
  {{
    "author": "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–º—è (—Ä–∞–∑–Ω–æ–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑!)",
    "date": "YYYY-MM-DD (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã)",
    "rating": 5,
    "text": "–ñ–∏–≤–æ–π —Ç–µ–∫—Å—Ç —Å —ç–º–æ—Ü–∏—è–º–∏, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —Å—Ç–∏–ª–µ–º. –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∏–¥–µ–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞. –ú–Ω–æ–≥–æ—Ç–æ—á–∏—è... –∏ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è! –û–±—Ä—ã–≤—ã –º—ã—Å–ª–∏. –í –æ–±—â–µ–º, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç.",
    "pros": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–ª—é—Å—ã (–Ω–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã!)",
    "cons": "5‚òÖ=–ø—É—Å—Ç–æ –∏–ª–∏ '-', 4‚òÖ=–Ω–µ–±–æ–ª—å—à–æ–π –º–∏–Ω—É—Å, 3‚òÖ=—Å–µ—Ä—å—ë–∑–Ω–∞—è –ø—Ä–µ—Ç–µ–Ω–∑–∏—è",
    "project": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫—É—Ö–Ω—è, —Å–ø–∞–ª—å–Ω—è, –≤–∞–Ω–Ω–∞—è –∏ —Ç.–¥.)"
  }}
]
```

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –ö–∞–∂–¥—ã–π –æ—Ç–∑—ã–≤ = —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
2. –î–∞—Ç—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ {date_range}
3. –ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫ (–Ω–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π!)
4. –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ (—Ä–∞–∑–º–µ—Ä—ã, –≤—Ä–µ–º—è, –º–µ—Å—Ç–æ)
5. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –∏ –æ–±—Ä—ã–≤—ã –º—ã—Å–ª–∏
6. –ú–∏–Ω—É—Å—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ—Ü–µ–Ω–∫–µ (4‚òÖ=–µ—Å—Ç—å, 3‚òÖ=—Å–µ—Ä—å—ë–∑–Ω—ã–µ)

–í–´–í–ï–î–ò –¢–û–õ–¨–ö–û JSON –ú–ê–°–°–ò–í, –ë–ï–ó –ü–û–Ø–°–ù–ï–ù–ò–ô!

–ù–ê–ß–ù–ò –ì–ï–ù–ï–†–ê–¶–ò–Æ {count} –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–• –û–¢–ó–´–í–û–í:"""
    
    try:
        # –í—ã–∑—ã–≤–∞–µ–º Claude API
        from ai.text_generator import client
        
        if not client:
            raise Exception("Claude API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=4000,
            messages=[
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        )
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
        response_text = response.content[0].text
        
        # –ü–∞—Ä—Å–∏–º JSON
        json_match = re.search(r'\[.*\]', response_text, re.DOTALL)
        if not json_match:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω JSON –≤ –æ—Ç–≤–µ—Ç–µ")
        
        reviews_data = json.loads(json_match.group())
        
        if not reviews_data:
            raise ValueError("–ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        generated_reviews_storage[chat_id] = {
            'category_id': category_id,
            'reviews': reviews_data
        }
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –æ—Ç–∑—ã–≤ –∫–∞–∫ –ø—Ä–µ–≤—å—é
        first_review = reviews_data[0]
        stars = "‚òÖ" * first_review['rating'] + "‚òÜ" * (5 - first_review['rating'])
        
        text = (
            f"‚úÖ <b>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(reviews_data)} –æ—Ç–∑—ã–≤(–æ–≤)!</b>\n\n"
            f"üí≥ <b>–°–ø–∏—Å–∞–Ω–æ:</b> {cost} —Ç–æ–∫–µ–Ω–æ–≤\n"
            f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {new_balance:,} —Ç–æ–∫–µ–Ω–æ–≤\n\n"
            f"<b>–ü—Ä–µ–≤—å—é –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∑—ã–≤–∞:</b>\n\n"
            f"{stars} <b>{first_review['author']}</b> | {first_review['date']}\n\n"
            f"{first_review['text']}\n\n"
            f"<b>–ü–ª—é—Å—ã:</b> {first_review.get('pros', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        )
        
        if first_review.get('cons'):
            text += f"<b>–ú–∏–Ω—É—Å—ã:</b> {first_review['cons']}\n"
        
        text += f"\n<b>–ü—Ä–æ–µ–∫—Ç:</b> {first_review.get('project', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}"
        
        markup = types.InlineKeyboardMarkup(row_width=1)
        markup.add(
            types.InlineKeyboardButton(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å {len(reviews_data)} –æ—Ç–∑—ã–≤(–æ–≤)", callback_data=f"save_reviews_{category_id}"),
            types.InlineKeyboardButton("üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data=f"gen_reviews_{category_id}"),
            types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"category_reviews_{category_id}")
        )
        
        bot.edit_message_text(
            text,
            chat_id,
            call.message.message_id,
            reply_markup=markup,
            parse_mode='HTML'
        )
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤: {e}")
        import traceback
        traceback.print_exc()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã
        db.update_tokens(user_id, cost)
        
        bot.edit_message_text(
            f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤: {e}\n\n"
            f"–¢–æ–∫–µ–Ω—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –≤–∞—à —Å—á—ë—Ç.",
            chat_id,
            call.message.message_id
        )


@bot.callback_query_handler(func=lambda call: call.data.startswith("save_reviews_"))
def handle_save_reviews(call):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤"""
    category_id = int(call.data.split("_")[-1])
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–∑—ã–≤—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    if chat_id not in generated_reviews_storage:
        safe_answer_callback(bot, call.id, "‚ùå –û—Ç–∑—ã–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", show_alert=True)
        return
    
    reviews_data = generated_reviews_storage[chat_id]['reviews']
    
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        db.cursor.execute("""
            UPDATE categories
            SET reviews = %s::jsonb
            WHERE id = %s
        """, (json.dumps(reviews_data, ensure_ascii=False), category_id))
        db.conn.commit()
        
        # –û—á–∏—â–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        del generated_reviews_storage[chat_id]
        
        text = (
            f"‚úÖ <b>–û–¢–ó–´–í–´ –°–û–•–†–ê–ù–ï–ù–´</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: <b>{len(reviews_data)}</b> –æ—Ç–∑—ã–≤–æ–≤\n\n"
            "–û—Ç–∑—ã–≤—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!"
        )
        
        markup = types.InlineKeyboardMarkup()
        markup.add(
            types.InlineKeyboardButton("üîô –ö –æ—Ç–∑—ã–≤–∞–º", callback_data=f"category_reviews_{category_id}")
        )
        
        bot.edit_message_text(
            text,
            chat_id,
            call.message.message_id,
            reply_markup=markup,
            parse_mode='HTML'
        )
        
        safe_answer_callback(bot, call.id, "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
        safe_answer_callback(bot, call.id, "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", show_alert=True)


@bot.callback_query_handler(func=lambda call: call.data.startswith("view_all_reviews_"))
def handle_view_all_reviews(call):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    category_id = int(call.data.split("_")[-1])
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    category = db.get_category(category_id)
    if not category:
        safe_answer_callback(bot, call.id, "‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    category_name = category.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
    reviews = category.get('reviews', [])
    
    if not reviews or not isinstance(reviews, list):
        safe_answer_callback(bot, call.id, "‚ùå –ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤", show_alert=True)
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ –≤—Å–µ–º–∏ –æ—Ç–∑—ã–≤–∞–º–∏
    text = (
        f"‚≠êÔ∏è <b>–í–°–ï –û–¢–ó–´–í–´</b>\n"
        f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {escape_html(category_name)}\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"üìä –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <b>{len(reviews)}</b>\n\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã
    for i, review in enumerate(reviews, 1):
        rating = review.get('rating', 5)
        stars = "‚òÖ" * rating + "‚òÜ" * (5 - rating)
        author = review.get('author', '–ê–Ω–æ–Ω–∏–º')
        date = review.get('date', '')
        review_text = review.get('text', '')
        pros = review.get('pros', '')
        cons = review.get('cons', '')
        
        text += f"<b>{i}. {stars} {escape_html(author)}</b>"
        if date:
            text += f" | {date}"
        text += "\n\n"
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
        if len(review_text) > 150:
            text += f"{escape_html(review_text[:150])}...\n"
        else:
            text += f"{escape_html(review_text)}\n"
        
        if pros:
            text += f"‚úÖ {escape_html(pros)}\n"
        
        if cons:
            text += f"‚ùå {escape_html(cons)}\n"
        
        text += "\n"
    
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    markup = types.InlineKeyboardMarkup()
    markup.add(
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"category_reviews_{category_id}")
    )
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        bot.delete_message(call.message.chat.id, call.message.message_id)
    except:
        pass
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º)
    try:
        bot.send_message(call.message.chat.id, text, reply_markup=markup, parse_mode='HTML')
    except Exception as e:
        # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
        if "message is too long" in str(e).lower():
            short_text = (
                f"‚≠êÔ∏è <b>–û–¢–ó–´–í–´ (–ø–µ—Ä–≤—ã–µ 5)</b>\n"
                f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {escape_html(category_name)}\n"
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"üìä –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <b>{len(reviews)}</b>\n\n"
            )
            
            for i, review in enumerate(reviews[:5], 1):
                rating = review.get('rating', 5)
                stars = "‚òÖ" * rating + "‚òÜ" * (5 - rating)
                author = review.get('author', '–ê–Ω–æ–Ω–∏–º')
                date = review.get('date', '')
                review_text = review.get('text', '')
                
                short_text += f"<b>{i}. {stars} {escape_html(author)}</b>"
                if date:
                    short_text += f" | {date}"
                short_text += f"\n{escape_html(review_text[:100])}...\n\n"
            
            short_text += f"<i>... –∏ –µ—â—ë {len(reviews) - 5} –æ—Ç–∑—ã–≤–æ–≤</i>\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            bot.send_message(call.message.chat.id, short_text, reply_markup=markup, parse_mode='HTML')
        else:
            safe_answer_callback(bot, call.id, f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)
    
    safe_answer_callback(bot, call.id)
